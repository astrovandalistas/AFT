<!DOCTYPE html>
<html>
  <head>
    <title>An Argument For Technology</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
  </head>
  <body>
    <div id="modal">
      <div id="modal-text" class="styled-text"></div>
    </div>
    <div class="container">
      <div id="word0" class="word styled-text"></div>
      <div id="word1" class="word styled-text"></div>
    </div>
    <div class="container">
      <div class="container-row">
        <div id="word2" class="word styled-text word4"></div>
        <div id="word3" class="word styled-text word4"></div>
      </div>
      <div class="container-row">
        <div id="word4" class="word styled-text word4"></div>
        <div id="word5" class="word styled-text word4"></div>
      </div>
    </div>
    <script src="./js/ajax-utils.js"></script>
    <script src="./js/phrases.js"></script>

    <script>
      const PHRASES_LIMIT = 16;
      const TWITTER_SERVICE_URL = 'https://aftwitterstream.herokuapp.com/AFT';
      const timeouts = [null, null, null, null, null, null];
      const currentWordIndex = [0, 0, 0, 0, 0, 0];
      const currentPhrase = [];
      const wordEls = [];
      var insertIndex = 0;

      window.onload = function() {
        for(let i = 0; i < timeouts.length; i++) {
          currentPhrase.push(phrases[i].split(' '));
          wordEls.push(document.getElementById('word' + i));
          setWord(i)();
          if(i > 1) setWordOpacity(wordEls[i], 0);
        }

        setInterval(function() {
          ajaxGet(TWITTER_SERVICE_URL, function(tweetPhrase){
            if(phrases.length < PHRASES_LIMIT) {
              phrases.push(tweetPhrase+' &nbsp;');
            } else if(phrases.length > PHRASES_LIMIT) {
              phrases = phrases.slice(0, PHRASES_LIMIT);
            } else {
              phrases[insertIndex] = tweetPhrase+' &nbsp;';
              insertIndex = (insertIndex + 1) % phrases.length;
            }
          });
        }, 30e3);

        setTimeout(updateConversationFormat, 20e3);
      }

      function setWord(i) {
        return function() {
          document.getElementById('word' + i).innerHTML = currentPhrase[i][currentWordIndex[i]];
          let tWord = document.getElementById('word' + i).innerHTML;
          let oWord = document.getElementById('word' + (i + 1) % 2).innerHTML;
          let timeoutValue = 80 + 200 * Math.random() + 80 * tWord.length;

          if((i < 2) && (tWord == oWord)) {
            document.getElementById('modal-text').innerHTML = currentPhrase[i][currentWordIndex[i]];
            document.getElementById('modal').style.opacity = 1;
            for(let t = 0; t < 2; t++) {
              if(timeouts[t] != null) {
                clearTimeout(timeouts[t]);
              }
              timeouts[t] = setTimeout(setWord(t % 2), 700);
              setTimeout(function() {
                document.getElementById('modal').style.opacity = 0;
              }, 700);
            }
          } else {
            timeouts[i] = setTimeout(setWord(i), timeoutValue);
          }

          currentWordIndex[i] = (currentWordIndex[i] + 1);
          if(currentWordIndex[i] >= currentPhrase[i].length) {
            currentPhrase[i] = phrases[Math.floor(phrases.length * Math.random())].split(' ');
            currentWordIndex[i] = 0;
          }
        }
      }

      function setWordOpacity(el, v) {
        el.style.opacity = `${v}`;
      }

      function updateConversationFormat() {
        const rand = Math.random();
        wordEls.forEach((e) => { setWordOpacity(e, 0); });

        if(rand < 0.25) {
          setWordOpacity(wordEls[0], 1);
          setWordOpacity(wordEls[1], 1);
        } else if(rand < 0.5) {
          setWordOpacity(wordEls[2], 1);
          setWordOpacity(wordEls[3], 1);
          setWordOpacity(wordEls[4], 1);
          setWordOpacity(wordEls[5], 1);
        } else if(rand < 0.75) {
          setWordOpacity(wordEls[0], 1);
          setWordOpacity(wordEls[4], 1);
          setWordOpacity(wordEls[5], 1);
        } else {
          setWordOpacity(wordEls[1], 1);
          setWordOpacity(wordEls[2], 1);
          setWordOpacity(wordEls[3], 1);
        }

        setTimeout(updateConversationFormat, 10e3 + 30e3 * Math.random());
      }
    </script>
  </body>
</html>
