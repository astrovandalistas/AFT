<!DOCTYPE html>
<html>
  <head>
    <title>An Argument For Technology</title>
    <link rel="stylesheet" href="./css/main.css">
  </head>
  <body>
    <div id="modal">
      <div id="modal-text" class="styled-text"></div>
    </div>
    <div id="container">
      <div id="word0" class="word styled-text"></div>
      <div id="word1" class="word styled-text"></div>
    </div>
    <script src="./js/ajax-utils.js"></script>
    <script src="./js/phrases.js"></script>

    <script>
      var PHRASES_LIMIT = 16;
      var TWITTER_SERVICE_URL = "https://aftwitterstream.herokuapp.com/AFT";
      var timeouts = [null, null];
      var currentWordIndex = [0,0];
      var currentPhrase = [];
      var insertIndex = 0;

      window.onload = function() {
        currentPhrase[0] = phrases[0].split(" ");
        currentPhrase[1] = phrases[Math.max(phrases.length - 1,0)].split(" ");
        setWord(0)();
        setWord(1)();
        setInterval(function() {
          ajaxGet(TWITTER_SERVICE_URL, function(tweetPhrase){
            if(phrases.length < PHRASES_LIMIT) {
              phrases.push(tweetPhrase+" &nbsp;");
            } else if(phrases.length > PHRASES_LIMIT) {
              phrases = phrases.slice(0, PHRASES_LIMIT);
            } else {
              phrases[insertIndex] = tweetPhrase+" &nbsp;";
              insertIndex = (insertIndex + 1) % phrases.length;
            }
          });
        }, 30e3);
      }

      function setWord(i) {
        return function() {
          document.getElementById("word"+i).innerHTML = currentPhrase[i][currentWordIndex[i]];
          var tWord = document.getElementById("word"+i).innerHTML;
          var oWord = document.getElementById("word"+(i + 1) % 2).innerHTML;
          var timeoutValue = 50 + 50 * Math.random() + 50 * tWord.length;

          if(tWord == oWord) {
            document.getElementById("modal-text").innerHTML = currentPhrase[i][currentWordIndex[i]];
            document.getElementById("modal").style.opacity = 1;
            for(var t=0; t<timeouts.length; t++) {
              if(timeouts[t] != null) {
                clearTimeout(timeouts[t]);
              }
              timeouts[t] = setTimeout(setWord(t % 2), 700);
            }
          } else {
            document.getElementById("modal").style.opacity = 0;
            timeouts[i] = setTimeout(setWord(i), timeoutValue);
          }

          currentWordIndex[i] = (currentWordIndex[i] + 1);
          if(currentWordIndex[i] >= currentPhrase[i].length) {
            currentPhrase[i] = phrases[Math.floor(phrases.length * Math.random())].split(" ");
            currentWordIndex[i] = 0;
          }
        }
      }
    </script>
  </body>
</html>
